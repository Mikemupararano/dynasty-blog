{% extends 'blog/base.html' %}
{% load blog_tags %}

{% block title %}
  {{ post.title }}
{% endblock %}

{% block content %}
  <h1>{{ post.title }}</h1>
  <p class="date">
    Published {{ post.published }} by {{ post.author.get_full_name|default:post.author.username }}
  </p>

  {# Optional media: image, audio, video #}
  {% if post.image or post.audio or post.video %}
    <section class="post-media" style="margin: 1rem 0;">

      {% if post.image %}
        <figure style="margin: 0 0 1rem 0;">
          <img src="{{ post.image.url }}" alt="{{ post.title }}" style="max-width:100%;height:auto;" />
        </figure>
      {% endif %}

      {% if post.audio %}
        <div class="post-audio" style="margin: 0 0 1rem 0;">
          <audio controls preload="none" style="width:100%;">
            <source src="{{ post.audio.url }}" />
            Your browser does not support the audio element.
          </audio>
          <p style="margin-top: .25rem;">
            <a href="{{ post.audio.url }}" download>Download audio</a>
          </p>
        </div>
      {% endif %}

      {% if post.video %}
        <div class="post-video" style="margin: 0 0 1rem 0;">
          {# Responsive 16:9 wrapper with a max height so text remains visible #}
          <div
            style="
              position:relative;
              width:100%;
              background:#000;
              border-radius:8px;
              overflow:hidden;
              /* 16:9 aspect ratio box */
              padding-top:56.25%;
              /* cap height on tall screens */
              max-height:60vh;
              box-shadow:0 2px 5px rgba(0,0,0,0.1);
            "
          >
            <video
              controls
              preload="metadata"
              {% if post.image %}poster="{{ post.image.url }}"{% endif %}
              style="
                position:absolute;
                inset:0;
                width:100%;
                height:100%;
                object-fit:contain;  /* letterbox if needed */
                background:#000;
              "
            >
              {% with vurl=post.video.url|lower %}
                {% if vurl|slice:"-4:" == ".mp4" %}
                  <source src="{{ post.video.url }}" type="video/mp4">
                {% elif vurl|slice:"-5:" == ".webm" %}
                  <source src="{{ post.video.url }}" type="video/webm">
                {% elif vurl|slice:"-4:" == ".ogg" %}
                  <source src="{{ post.video.url }}" type="video/ogg">
                {% else %}
                  <source src="{{ post.video.url }}">
                {% endif %}
              {% endwith %}
              Your browser cannot play this video.
            </video>
          </div>

          <p style="margin-top: .25rem;">
            <a href="{{ post.video.url }}" download>Download video</a>
          </p>
        </div>
      {% endif %}

    </section>
  {% endif %}

  {{ post.body|markdown }}

  <p>
    <a href="{% url 'blog:post_share' post.id %}">Share this post</a>
  </p>

  <h2>Similar posts</h2>
  {% for s in similar_posts %}
    <p>
      <a href="{{ s.get_absolute_url }}">{{ s.title }}</a>
    </p>
  {% empty %}
    <p>There are no similar posts yet.</p>
  {% endfor %}

  {% with total_comments=comments.count %}
    <h2>{{ total_comments }} comment{{ total_comments|pluralize }}</h2>
  {% endwith %}

  {% for comment in comments %}
    <div class="comment">
      <p class="info">
        Comment {{ forloop.counter }} by {{ comment.name }} {{ comment.created }}
      </p>
      <p>{{ comment.body|linebreaks }}</p>
    </div>
  {% empty %}
    <p>There are no comments.</p>
  {% endfor %}

  <hr />

  {# Include the form INSIDE the block and pass the vars explicitly #}
  {% include 'blog/post/includes/comment_form.html' with post=post form=form %}
{% endblock %}
